# ===================================
# AZURE REPOS -> GITHUB MIRROR PIPELINE (PTY4614 - Repositorio Padre)
# ===================================
# Mantiene sincronizados Azure Repos y GitHub incluyendo submódulos
# Solo mirroring - sin builds ni tests

name: 'Mirror-PTY4614-$(Date:yyyyMMdd)$(Rev:.r)'

# Trigger: Se ejecuta cuando hay push a estas ramas
trigger:
  branches:
    include:
      - main
      - develop
      - release/*
      - feature/*
  paths:
    exclude:
      - README.md
      - docs/*
      - '*.md'

# Pull Request: También sincroniza en PRs
pr:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/*
      - '*.md'

# Variables del pipeline
variables:
  - name: shouldMirror
    value: true
  - name: maxRetries
    value: 3

pool:
  name: home-office

stages:
- stage: MirrorToGitHub
  displayName: 'Mirror PTY4614 to GitHub'

  jobs:
  - job: PreValidation
    displayName: 'Pre-validation Checks'
    steps:
    - checkout: self
      fetchDepth: 0
      submodules: true
      displayName: 'Checkout with full history and submodules'

    - powershell: |
        Write-Host "=== PIPELINE INFORMATION (PTY4614 - Repo Padre) ==="
        Write-Host "Source Branch: $(Build.SourceBranch)"
        Write-Host "Branch Name: $(Build.SourceBranchName)"
        Write-Host "Repository: $(Build.Repository.Name)"
        Write-Host "Commit: $(Build.SourceVersion)"
        Write-Host "Trigger Reason: $(Build.Reason)"
        Write-Host "================================"

        # Verificar submódulos
        Write-Host "Verificando submódulos..."
        git submodule status

        if ($LASTEXITCODE -ne 0) {
            Write-Warning "No se detectaron submódulos o hay un problema"
        } else {
            Write-Host "Submódulos detectados correctamente"
        }

        # Verificar que las variables estén configuradas
        if (-not $env:GITHUB_USER -or -not $env:GITHUB_PAT -or -not $env:GITHUB_OWNER -or -not $env:GITHUB_REPO) {
            Write-Error "Variables de GitHub no configuradas correctamente"
            Write-Host "Variables necesarias: GITHUB_USER, GITHUB_PAT, GITHUB_OWNER, GITHUB_REPO"
            exit 1
        }
        Write-Host "Variables de GitHub configuradas correctamente"
        Write-Host "Target: https://github.com/$env:GITHUB_OWNER/$env:GITHUB_REPO"
      displayName: 'Display Build Information & Verify Submodules'
      env:
        GITHUB_USER: $(GITHUB_USER)
        GITHUB_PAT: $(GITHUB_PAT)
        GITHUB_OWNER: $(GITHUB_OWNER)
        GITHUB_REPO: $(GITHUB_REPO)

  - job: MirrorRepositoryToGitHub
    displayName: 'Mirror Repository to GitHub (with submodules)'
    dependsOn: PreValidation
    condition: and(succeeded(), eq(variables.shouldMirror, 'true'))

    steps:
    - checkout: self
      fetchDepth: 0
      submodules: recursive
      displayName: 'Checkout with full history and recursive submodules'

    - powershell: |
        $ErrorActionPreference = 'Continue'

        Write-Host "Configurando Git para repositorio con submódulos..."
        git config user.name "Azure DevOps Mirror"
        git config user.email "azuredevops-mirror@barriolink.com"
        git config core.autocrlf false
        git config push.default current

        # Importante para submódulos
        git config push.recurseSubmodules on-demand

        Write-Host "Información del repositorio padre:"
        git log --oneline -5
        Write-Host "Rama actual: $(git branch --show-current)"
        Write-Host "Ramas disponibles:"
        git branch -a

        Write-Host "`nEstado de submódulos:"
        git submodule status

        Write-Host "`nContenido de .gitmodules:"
        if (Test-Path ".gitmodules") {
            Get-Content ".gitmodules"
        } else {
            Write-Warning "No se encontró archivo .gitmodules"
        }

        Write-Host "`nConfigurando remote GitHub..."
        $remoteUrl = "https://$(GITHUB_USER):$(GITHUB_PAT)@github.com/$(GITHUB_OWNER)/$(GITHUB_REPO).git"

        # Verificar remotes existentes
        Write-Host "Remotes actuales:"
        git remote -v

        # Verificar si el remote github ya existe
        git remote get-url github 2>$null
        $remoteExists = $LASTEXITCODE -eq 0

        if ($remoteExists) {
            Write-Host "Remote 'github' ya existe, actualizando URL..."
            git remote set-url github $remoteUrl
        } else {
            Write-Host "Agregando nuevo remote 'github'..."
            git remote add github $remoteUrl
        }

        Write-Host "Remotes después de configuración:"
        git remote -v

        Write-Host "`nVerificando conectividad con GitHub..."
        git ls-remote github HEAD 2>&1
        if ($LASTEXITCODE -ne 0) {
            Write-Error "No se puede conectar a GitHub. Verificar credenciales y configuración."
            Write-Host "Debugging: Verificar GITHUB_USER, GITHUB_PAT, GITHUB_OWNER, GITHUB_REPO"
            exit 1
        }
        Write-Host "Conexión a GitHub exitosa"

      displayName: 'Configure Git, Submodules and GitHub Remote'
      env:
        GITHUB_USER: $(GITHUB_USER)
        GITHUB_PAT: $(GITHUB_PAT)
        GITHUB_OWNER: $(GITHUB_OWNER)
        GITHUB_REPO: $(GITHUB_REPO)

    - powershell: |
        $ErrorActionPreference = 'Continue'

        # Obtener el nombre completo de la rama desde Build.SourceBranch
        $sourceBranch = "$(Build.SourceBranch)"
        $branch = $sourceBranch -replace "refs/heads/", ""
        $remoteRef = "refs/heads/$branch"

        Write-Host "Source Branch: $sourceBranch"
        Write-Host "Rama extraida: $branch"
        Write-Host "Destino remoto: $remoteRef"

        $maxRetries = $(maxRetries)
        $retryCount = 0
        $success = $false

        Write-Host "Iniciando mirror de la rama: $branch (con submódulos)"
        Write-Host "Target: $(GITHUB_OWNER)/$(GITHUB_REPO)"

        # Verificar estado actual del repositorio
        Write-Host "`nEstado actual del repositorio:"
        Write-Host "Rama local actual: $(git branch --show-current)"
        Write-Host "Commit actual: $(git rev-parse HEAD)"
        Write-Host "Submódulos:"
        git submodule status

        # Verificar si la rama existe en GitHub
        Write-Host "`nVerificando si la rama '$branch' existe en GitHub..."
        git ls-remote --heads github $branch 2>&1
        $branchExistsOnGitHub = $LASTEXITCODE -eq 0

        if ($branchExistsOnGitHub) {
            Write-Host "La rama '$branch' ya existe en GitHub"
        } else {
            Write-Host "La rama '$branch' NO existe en GitHub - se creará automáticamente"
        }

        while (-not $success -and $retryCount -lt $maxRetries) {
            $retryCount++
            Write-Host "`n=== Intento $retryCount de $maxRetries ==="

            try {
                # Fetch de GitHub
                Write-Host "Obteniendo referencias de GitHub..."
                git fetch github 2>&1

                if ($branchExistsOnGitHub) {
                    Write-Host "La rama '$branch' existe en GitHub, sincronizando..."

                    # Obtener commits para comparar
                    $localCommit = git rev-parse HEAD
                    $remoteCommit = git rev-parse "github/$branch" 2>$null

                    Write-Host "Local:  $localCommit"
                    Write-Host "Remoto: $remoteCommit"

                    if ($localCommit -eq $remoteCommit) {
                        Write-Host "Las ramas están sincronizadas, verificando submódulos..."

                        # Aun así, forzar push para asegurar que submódulos estén actualizados
                        Write-Host "Push con --recurse-submodules=on-demand para sincronizar submódulos..."
                        git push github "HEAD:$remoteRef" --recurse-submodules=on-demand 2>&1
                    } else {
                        Write-Host "Push con --force-with-lease y submódulos..."
                        git push github "HEAD:$remoteRef" --force-with-lease --recurse-submodules=on-demand 2>&1
                    }
                } else {
                    # Si la rama no existe, crearla directamente
                    Write-Host "Creando nueva rama '$branch' en GitHub con submódulos..."
                    git push github "HEAD:$remoteRef" --recurse-submodules=on-demand 2>&1
                }

                if ($LASTEXITCODE -eq 0) {
                    Write-Host "Mirror exitoso para la rama '$branch'"
                    $success = $true

                    # Verificar que el push fue exitoso
                    Write-Host "`nVerificando el push..."
                    git ls-remote --heads github $branch 2>&1
                    if ($LASTEXITCODE -eq 0) {
                        Write-Host "✓ Verificación exitosa - rama sincronizada correctamente"

                        # Verificar .gitmodules en GitHub
                        Write-Host "`nVerificando que .gitmodules se sincronizó..."
                        git ls-remote github "HEAD:.gitmodules" 2>&1
                        if ($LASTEXITCODE -eq 0) {
                            Write-Host "✓ Archivo .gitmodules confirmado en GitHub"
                        } else {
                            Write-Warning ".gitmodules podría no estar en GitHub aún"
                        }
                    }
                } else {
                    throw "Git push falló con código $LASTEXITCODE"
                }
            }
            catch {
                Write-Warning "Intento $retryCount falló: $($_.Exception.Message)"
                if ($retryCount -lt $maxRetries) {
                    Write-Host "Esperando 10 segundos antes del siguiente intento..."
                    Start-Sleep -Seconds 10

                    # Re-verificar si la rama ahora existe
                    git ls-remote --heads github $branch 2>&1
                    $branchExistsOnGitHub = $LASTEXITCODE -eq 0
                } else {
                    Write-Error "Todos los intentos de mirror fallaron"
                    Write-Host "`nInformación de debugging:"
                    Write-Host "- Rama: $branch"
                    Write-Host "- GitHub Owner: $(GITHUB_OWNER)"
                    Write-Host "- GitHub Repo: $(GITHUB_REPO)"
                    Write-Host "- Submódulos:"
                    git submodule status
                    Write-Host "- Último error: $($_.Exception.Message)"
                    exit 1
                }
            }
        }

        Write-Host "`n✓ Mirror completado exitosamente!"
        Write-Host "URL: https://github.com/$(GITHUB_OWNER)/$(GITHUB_REPO)/tree/$branch"

      displayName: 'Push to GitHub with Submodules and Retry Logic'
      env:
        GITHUB_OWNER: $(GITHUB_OWNER)
        GITHUB_REPO: $(GITHUB_REPO)

    - powershell: |
        # Obtener el nombre completo de la rama
        $sourceBranch = "$(Build.SourceBranch)"
        $branch = $sourceBranch -replace "refs/heads/", ""

        Write-Host "`n======================================="
        Write-Host "RESUMEN DEL MIRROR (PTY4614 - Repo Padre)"
        Write-Host "======================================="
        Write-Host "Repositorio: PTY4614 (con submódulos)"
        Write-Host "Rama sincronizada: $branch"
        Write-Host "Commit: $(Build.SourceVersion)"
        Write-Host "Build: $(Build.BuildNumber)"
        Write-Host "Hora: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Write-Host ""
        Write-Host "GitHub URLs:"
        Write-Host "  - Repositorio: https://github.com/$(GITHUB_OWNER)/$(GITHUB_REPO)"
        Write-Host "  - Rama: https://github.com/$(GITHUB_OWNER)/$(GITHUB_REPO)/tree/$branch"
        Write-Host "  - .gitmodules: https://github.com/$(GITHUB_OWNER)/$(GITHUB_REPO)/blob/$branch/.gitmodules"
        Write-Host ""
        Write-Host "Submódulos incluidos:"
        git submodule status | ForEach-Object {
            Write-Host "  $_"
        }
        Write-Host "======================================="

        # Verificación final de sincronización
        Write-Host "`nVerificación final..."
        git ls-remote --heads github $branch 2>&1
        if ($LASTEXITCODE -eq 0) {
            Write-Host "✓ Sincronización confirmada - rama disponible en GitHub"
            Write-Host "✓ Los submódulos deben estar referenciados en .gitmodules"
        } else {
            Write-Warning "No se pudo verificar la sincronización"
        }
      displayName: 'Mirror Summary'
      env:
        GITHUB_OWNER: $(GITHUB_OWNER)
        GITHUB_REPO: $(GITHUB_REPO)
      condition: always()
